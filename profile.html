<!DOCTYPE HTML>
<!--
	Identity by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Identity by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
        
        <style>
            .edit-icon {
                opacity: 40%;
                color: #cc796b;
                cursor: pointer;
                float: right;
                margin: auto;
                line-height: 1.5;
                font-style: oblique;
                font-size: x-large;
            }
            
            .field {
                margin-top: 2%;  
                margin-bottom: 2%; 
            }
            
            .hidden {
                display: none!important;
            }
        </style>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
                    <img src="images/empushy_white_no_caption.png" style="width: 15%; cursor: pointer;" onclick="window.location.replace('/')"/>
					<section id="main" style="min-height: 78vh;">
                        <span id="settingsButton" style="float: right; cursor: pointer; position: absolute; right:5%;" onclick="settings()"><i class="fas fa-2x fa-cog" style="opacity: 60%;"></i></span>
						<header>
							<span class="avatar">
                                <img src="images/avatar.jpg" alt=""/>
                            </span>
							<h1 id="profileName" class="hidden">Jane Doe</h1>
                            <div class="field">
                                <input type="text" id="editName" placeholder="Jane Doe"/>
                            </div>
							<p id="tagline" class="hidden">Tagline</p>
                            <div class="field">
                                <input type="text" id="editTagline" placeholder="Tagline" />
                            </div>
						</header>
                        <p id="toShareLine" style="letter-spacing: normal; font-family: inherit; text-transform: none;  margin-bottom: 1%;">Your unique EmPushy link to share:</p>
                        <i id='toshareIcon' onclick="copyShareLink()" class="far fa-clipboard" style="cursor: pointer;"></i>
                        <small id='toshare' style="font-size: x-small; letter-spacing: normal; font-family: inherit; text-transform: none;"></small>
						<!--
						<hr />
						<h2>Extra Stuff!</h2>
						<form method="post" action="#">
							<div class="fields">
								<div class="field">
									<input type="text" name="name" id="name" placeholder="Name" />
								</div>
								<div class="field">
									<input type="email" name="email" id="email" placeholder="Email" />
								</div>
								<div class="field">
									<select name="department" id="department">
										<option value="">Department</option>
										<option value="sales">Sales</option>
										<option value="tech">Tech Support</option>
										<option value="null">/dev/null</option>
									</select>
								</div>
								<div class="field">
									<textarea name="message" id="message" placeholder="Message" rows="4"></textarea>
								</div>
								<div class="field">
									<input type="checkbox" id="human" name="human" /><label for="human">I'm a human</label>
								</div>
								<div class="field">
									<label>But are you a robot?</label>
									<input type="radio" id="robot_yes" name="robot" /><label for="robot_yes">Yes</label>
									<input type="radio" id="robot_no" name="robot" /><label for="robot_no">No</label>
								</div>
							</div>
							<ul class="actions special">
								<li><a href="#" class="button">Get Started</a></li>
							</ul>
						</form>
						<hr />
						-->
						<footer>
                            <hr style="margin-top: 10%; margin-bottom: 10%;">
							<ul class="icons">
								<li id="twitterField" class="hidden"><a id="twitterLink" href="#" target="_blank" class="icon brands fa-twitter">Twitter</a></li>
                                <li id="editTwitterField">
                                    <div class="field">
                                        <input type="text" id="editTwitter" placeholder="Twitter link" />
                                    </div>
                                </li>
								<li id="instagramField" class="hidden"><a id="instagramLink" href="#" target="_blank" class="icon brands fa-instagram">Instagram</a></li>
								<li id="editInstagramField">
                                    <div class="field" >
                                        <input type="text" id="editInstagram" placeholder="Instagram link" />
                                    </div>
                                </li>
								<li id="facebookField" class="hidden"><a id="facebookLink" href="#" target="_blank" class="icon brands fa-facebook-f">Facebook</a></li>
								<li  id="editFacebookField">
                                    <div class="field">
                                        <input type="text" id="editFacebook" placeholder="Facebook link" />
                                    </div>
                                </li>
							</ul>
                            <button id='subButton' class="button" onclick="subButtonClick()" disabled>Subscribe</button>
							<button id='logoutButton' class="button" onclick="logout()">Logout</button>
                            <button id='editButton' class="button" onclick="edit()">Edit</button>
                            <button id='saveButton' class="button" onclick="save()">Save</button>
                            <button id='pushButton' class="button" onclick="window.location.replace('/push.html')">Push</button>
						</footer>
					</section>

				<!-- Footer -->
					<footer id="footer">
						<ul class="copyright">
							<li>&copy; EmPushy</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
						</ul>
					</footer>

			</div>

		<!-- Scripts -->
            <script
              src="https://code.jquery.com/jquery-3.4.1.min.js"
              integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
              crossorigin="anonymous"></script>
            <!-- The core Firebase JS SDK is always required and must be listed first -->
            <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
            <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>
        
            <script type="application/javascript" src="assets/js/test.js"></script>
			<script>
                                
                // Your web app's Firebase configuration
                var firebaseConfig = {
                    apiKey: "AIzaSyBJpTtm__4p2TRQnBs71PG5u0odryHPxqs",
                    authDomain: "autoempushy.firebaseapp.com",
                    databaseURL: "https://autoempushy.firebaseio.com",
                    projectId: "autoempushy",
                    storageBucket: "autoempushy.appspot.com",
                    messagingSenderId: "787581605206",
                    appId: "1:787581605206:web:5cc765820a98b8008d32f7",
                    measurementId: "G-NWVD0JG36T"
                };
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                var db = firebase.database();
                
				if ('addEventListener' in window) {
					window.addEventListener('load', function() { document.body.className = document.body.className.replace(/\bis-preload\b/, ''); });
					document.body.className += (navigator.userAgent.match(/(MSIE|rv:11\.0)/) ? ' is-ie' : '');
				}
                
                window.addEventListener('load', function() {
                    initApp();
                });
                
                function getPublicInfo(uid){
                    
                    var publicProfileURL = "http://localhost:5000/v1/public-profile";
                    if(uid!=null){
                        var formData = JSON.stringify({
                            'uid': uid         
                        })

                        $.ajax ({
                            url: publicProfileURL,
                            type: "POST",
                            data: formData,
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            crossDomain: true,
                            success: function(data) {
                                try{
                                    
                                    if(data['success']){
                                        $('#profileName').text(data['snapshot']['name'])
                                        $('#editName').val(data['snapshot']['name'])
                                        
                                        $('#tagline').text(data['snapshot']['tagline'])
                                        $('#editTagline').val(data['snapshot']['tagline'])
                                        
                                        $('#profileName').removeClass('hidden')
                                        $('#tagline').removeClass('hidden')
                                        
                                        if(data['snapshot']['twitterURL']!=""){
                                            $('#twitterLink').attr('href', data['snapshot']['twitterURL'])
                                            $('#editTwitter').val(data['snapshot']['twitterURL'])
                                            $('#twitterField').removeClass('hidden')
                                        }
                                        else{
                                            $('#twitterField').hide()
                                        }
                                        
                                        if(data['snapshot']['instagramURL']!=""){
                                            $('#instagramLink').attr('href', data['snapshot']['instagramURL'])
                                            $('#editInstagram').val(data['snapshot']['instagramURL'])
                                            $('#instagramField').removeClass('hidden')
                                        }
                                        else{
                                            $('#instagramField').hide()
                                        }
                                        
                                        if(data['snapshot']['facebookURL']!=""){
                                            $('#facebookLink').attr('href', data['snapshot']['facebookURL'])
                                            $('#editFacebook').val(data['snapshot']['facebookURL'])
                                            $('#facebookField').removeClass('hidden')
                                        }
                                        else{
                                            $('#facebookField').hide()
                                        }
                                        
                                    }
                                    /**/
                                }
                                catch(err){}
                            },
                            error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                
                            } 
                        });
                    }
                    
                    
                    
                }
                
                function initApp() {    
                    $('#editName').hide()
                    $('#editTagline').hide()
                    $('#editTwitterField').hide()
                    $('#editInstagramField').hide()
                    $('#editFacebookField').hide()
                    $('#saveButton').hide()
                    $('#toshare').hide()
                    $('#toShareLine').hide()
                    $('#toshareIcon').hide()
                    $('#logoutButton').hide()
                    $('#editButton').hide()
                    $('#pushButton').hide()
                    $('#settingsButton').hide()
                    
                    
                    firebase.auth().onAuthStateChanged(function(user) {
                        if (user) {
                            // User is signed in.
                            var email = user.email;
                            var uid = user.uid;
                            localStorage.setItem('userId', uid);
                            
                            // Get user from db
                            var userRef = db.ref('users/' + uid);
                            userRef.once('value').then(function(snapshot) {
                                if(snapshot.val()==null){
                                    // create user in db
                                    db.ref('users/' + uid).set({
                                        joined: (new Date().getTime()),
                                        name: 'Jane Doe',
                                        tagline: 'My tagline'
                                    });
                                }  
                                var shareableLink = (window.location.origin+'/profile.html?p='+uid).replace('http://', '').replace('https://', '')
                                $('#toshare').html(shareableLink)
                                $('#logoutButton').removeClass('hidden')
                                $('#editButton').removeClass('hidden')
                                $('#pushButton').removeClass('hidden')
                                $('#logoutButton').show()
                                $('#editButton').show()
                                $('#pushButton').show()
                                $('#toshare').show()
                                $('#toShareLine').show()
                                $('#toshareIcon').show()
                                $('#settingsButton').show()

                                getPublicInfo(uid)
                            });
                            
                        }
                        else {
                            const params = new URLSearchParams(window.location.search);  
                            uid = params.get("p");
                            getPublicInfo(uid)
                        }
                    }, function(error) {
                      console.log(error);
                    });
                }
                
                function edit(){
                    $('#profileName').hide()
                    $('#tagline').hide()
                    $('#twitterField').hide()
                    $('#instagramField').hide()
                    $('#facebookField').hide()
                    
                    $('#editName').show()
                    $('#editTagline').show()
                    $('#editTwitterField').show()
                    $('#editInstagramField').show()
                    $('#editFacebookField').show()
                    $('#editButton').hide()
                    $('#pushButton').hide()
                    $('#logoutButton').hide()
                    $('#saveButton').show()
                }
                
                function save(){
                    name = $('#editName').val()
                    tagline = $('#editTagline').val()
                    twitterURL = $('#editTwitter').val()
                    instagramURL = $('#editInstagram').val()
                    facebookURL = $('#editFacebook').val()
                    
                    $('#profileName').text(name)
                    $('#tagline').text(tagline)
                    $('#twitterLink').attr('href', twitterURL)
                    $('#instagramLink').attr('href', instagramURL)
                    $('#facebookLink').attr('href', facebookURL)
                    
                    $('#profileName').show()
                    $('#tagline').show()
                    
                    if(twitterURL==""){
                        $('#twitterField').hide()
                    }
                    else{
                        $('#twitterField').removeClass('hidden')
                        $('#twitterField').show()
                    }

                    if(instagramURL==""){
                        $('#instagramField').hide()
                    }
                    else{
                        $('#instagramField').removeClass('hidden')
                        $('#instagramField').show()
                    }

                    if(facebookURL==""){
                        $('#facebookField').hide()
                    }
                    else{
                        $('#facebookField').removeClass('hidden')
                        $('#facebookField').show()
                    }
                    
                    $('#editName').hide()
                    $('#editTagline').hide()
                    $('#editTwitterField').hide()
                    $('#editInstagramField').hide()
                    $('#editFacebookField').hide()
                    $('#saveButton').hide()
                    $('#logoutButton').show()
                    $('#editButton').show()
                    $('#pushButton').show()
                    
                    var updateURL = "http://localhost:5000/v1/update-profile";
                    uid = localStorage.getItem('userId')
                    if(uid!=null){
                        var formData = JSON.stringify({
                            'uid': uid,
                            'name': name,
                            'tagline': tagline,
                            'twitterURL': twitterURL,
                            'instagramURL': instagramURL,
                            'facebookURL': facebookURL          
                        })

                        $.ajax ({
                            url: updateURL,
                            type: "POST",
                            data: formData,
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            crossDomain: true,
                            success: function(data) {
                                try{
                                    
                                }
                                catch(err){}
                            },
                            error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                
                            } 
                        });
                    }
                }
                
                function logout(){
                    localStorage.clear();
                    firebase.auth().signOut();
                    window.location.replace("/index.html");
                }
                
                function copyShareLink() {
                    var copyText = 'http://'+$('#toshare').text();
                    var textarea = document.createElement("textarea");
                    textarea.textContent = copyText;
                    textarea.style.position = "fixed"; // Prevent scrolling to bottom of page in MS Edge.
                    textarea.style.textTransform = "none";
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy"); 
                    document.body.removeChild(textarea);
                }
                
                function settings() {
                    
                }
			</script>

	</body>
</html>