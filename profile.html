<!DOCTYPE HTML>
<!--
	Identity by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Identity by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
        <link rel="icon" type="image/png" href="images/favicon.png" sizes="32x32">
		<link rel="stylesheet" href="assets/css/ant-toast.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.css">
        
        <style>
            .edit-icon {
                opacity: 40%;
                color: #cc796b;
                cursor: pointer;
                float: right;
                margin: auto;
                line-height: 1.5;
                font-style: oblique;
                font-size: x-large;
            }
            
            .field {
                margin-top: 2%;  
                margin-bottom: 2%; 
            }
            
            .hidden {
                display: none!important;
            }
        </style>
	</head>
	<body class="is-preload">

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
                    <img src="images/pushd_white_no_caption_2.0.png" style="width: 200px; cursor: pointer;" onclick="window.location.replace('/login.html')"/>
                    
                    
                    <div style="display: flex;">
                        <section id="main" style="background-image: url(images/grey.png); background-repeat: repeat;">
                            <header>
                                <span class="avatar">
                                    <img id="profileImage" src="images/avatar.jpg" alt="" style="height:122px; width:122px;"/>
                                </span>
                                <label id="imageChooser" for="imageFileInput" class="chooser">Upload Photo</label>
                                <input id='imageFileInput' name="file" type="file" style="display: none;"/>
                                <h1 id="profileName" style="display: none;"></h1>
                                <div class="field">
                                    <input type="text" style="display: none;" id="editName" placeholder="Name"/>
                                </div>
                                <p id="tagline" style="display: none;"></p>
                                <div class="field">
                                    <input type="text" style="display: none;" id="editTagline" placeholder="Tagline" />
                                </div>
                            </header>
                            <p id="toShareLine" style="letter-spacing: normal; font-family: inherit; text-transform: none;  margin-bottom: 1%; display: none;">Your unique Pushd link to share:</p>
                            <i id='toshareIcon' onclick="copyShareLink()" class="far fa-clipboard" style="cursor: pointer; display: none;"></i>
                            <small id='toshare' style="font-size: x-small; letter-spacing: normal; font-family: inherit; text-transform: none;"></small>
                            <!--
                            <hr />
                            <h2>Extra Stuff!</h2>
                            <form method="post" action="#">
                                <div class="fields">
                                    <div class="field">
                                        <input type="text" name="name" id="name" placeholder="Name" />
                                    </div>
                                    <div class="field">
                                        <input type="email" name="email" id="email" placeholder="Email" />
                                    </div>
                                    <div class="field">
                                        <select name="department" id="department">
                                            <option value="">Department</option>
                                            <option value="sales">Sales</option>
                                            <option value="tech">Tech Support</option>
                                            <option value="null">/dev/null</option>
                                        </select>
                                    </div>
                                    <div class="field">
                                        <textarea name="message" id="message" placeholder="Message" rows="4"></textarea>
                                    </div>
                                    <div class="field">
                                        <input type="checkbox" id="human" name="human" /><label for="human">I'm a human</label>
                                    </div>
                                    <div class="field">
                                        <label>But are you a robot?</label>
                                        <input type="radio" id="robot_yes" name="robot" /><label for="robot_yes">Yes</label>
                                        <input type="radio" id="robot_no" name="robot" /><label for="robot_no">No</label>
                                    </div>
                                </div>
                                <ul class="actions special">
                                    <li><a href="#" class="button">Get Started</a></li>
                                </ul>
                            </form>
                            <hr />
                            -->
                            <footer>
                                <hr style="margin-top: 10%; margin-bottom: 10%;">
                                <ul class="icons">
                                    <li id="twitterField" style="display: none;"><a id="twitterLink" href="#" target="_blank" class="icon brands fa-twitter">Twitter</a></li>
                                    <li id="editTwitterField" style="display: none;">
                                        <div class="field">
                                            <input type="text" id="editTwitter" placeholder="Twitter link" />
                                        </div>
                                    </li>
                                    <li id="instagramField" style="display: none;"><a id="instagramLink" href="#" target="_blank" class="icon brands fa-instagram">Instagram</a></li>
                                    <li id="editInstagramField" style="display: none;">
                                        <div class="field" >
                                            <input type="text" id="editInstagram" placeholder="Instagram link" />
                                        </div>
                                    </li>
                                    <li id="facebookField" style="display: none;"><a id="facebookLink" href="#" target="_blank" class="icon brands fa-facebook-f">Facebook</a></li>
                                    <li  id="editFacebookField" style="display: none;">
                                        <div class="field">
                                            <input type="text" id="editFacebook" placeholder="Facebook link" />
                                        </div>
                                    </li>
                                </ul>
                                <button id='subButton' style="display: none;" class="button" onclick="subButtonClick()" disabled>Subscribe</button>
                                <button id='logoutButton' style="display: none;" class="button" onclick="logout()">Logout</button>
                                <button id='editButton' style="display: none;" class="button" onclick="edit()">Edit</button>
                                <button id='saveButton' style="display: none;" class="button" onclick="save()">Save</button>
                                <button id='pushButton' style="display: none;" class="button" onclick="pushButtonClick()">Push</button>
                            </footer>
                        </section>
                        <div id="settingsButtons" class="settingsButtons">
                            <span id="" class="settings" onclick="insights()"><img src="images/line-chart.png" style="width: 100%; opacity: 80%;"></span>
                            <span id="" class="settings" onclick="control()"><img src="images/control.png" style="width: 100%; opacity: 80%;"></span>
                            <span id="" class="settings" onclick="settings()"><img src="images/settings.png" style="width: 100%; opacity: 80%;"></span>
                        </div>
                    </div>

				<!-- Footer -->
					<footer id="footer">
						<ul class="copyright">
							<li>&copy; Pushd</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                            <li id="signInLink"><a href="/index.html">Sign In</a></li>
						</ul>
					</footer>

			</div>

		<!-- Scripts -->
        <script
          src="https://code.jquery.com/jquery-3.4.1.min.js"
          integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
          crossorigin="anonymous"></script>
        <!-- The core Firebase JS SDK is always required and must be listed first -->
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-auth.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.5.0/firebase-database.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-confirm/3.3.2/jquery-confirm.min.js"></script>
        <script src="assets/js/ant-toast.js"></script>
        
            <script type="application/javascript" src="assets/js/test.js"></script>
			<script>
                                
                // Your web app's Firebase configuration
                var firebaseConfig = {
                    apiKey: "AIzaSyBJpTtm__4p2TRQnBs71PG5u0odryHPxqs",
                    authDomain: "autoempushy.firebaseapp.com",
                    databaseURL: "https://autoempushy.firebaseio.com",
                    projectId: "autoempushy",
                    storageBucket: "autoempushy.appspot.com",
                    messagingSenderId: "787581605206",
                    appId: "1:787581605206:web:5cc765820a98b8008d32f7",
                    measurementId: "G-NWVD0JG36T"
                };
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                var db = firebase.database();
                
				if ('addEventListener' in window) {
					window.addEventListener('load', function() { document.body.className = document.body.className.replace(/\bis-preload\b/, ''); });
					document.body.className += (navigator.userAgent.match(/(MSIE|rv:11\.0)/) ? ' is-ie' : '');
				}
                
                window.addEventListener('load', function() {
                    initApp();
                });
                
                function getPublicInfo(uid){
                    
                    var publicProfileURL = "https://autoempushy.herokuapp.com/v1/public-profile";
                    if(uid!=null){
                        var formData = JSON.stringify({
                            'uid': uid         
                        })

                        $.ajax ({
                            url: publicProfileURL,
                            type: "POST",
                            data: formData,
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            crossDomain: true,
                            success: function(data) {
                                try{
                                    
                                    if(data['success']){                                        
                                        initSubscribe(data['snapshot']['applicationServerKey'])
                                        
                                        $('#profileName').text(data['snapshot']['name'])
                                        $('#editName').val(data['snapshot']['name'])
                                        
                                        imageURL = 'data:image/jpeg;base64'+data['snapshot']['profileImage']
                                        
                                        resizeProfilerForIcon(imageURL)
                                        $('#profileImage').attr('src', imageURL)
                                        
                                        $('#tagline').text(data['snapshot']['tagline'])
                                        $('#editTagline').val(data['snapshot']['tagline'])
                                        
                                        $('#profileName').show()
                                        $('#tagline').show()
                                        
                                        if(data['snapshot']['twitterURL']!=""){
                                            $('#twitterLink').attr('href', data['snapshot']['twitterURL'])
                                            $('#editTwitter').val(data['snapshot']['twitterURL'])
                                            $('#twitterField').show()
                                        }
                                        else{
                                            $('#twitterField').hide()
                                        }
                                        
                                        if(data['snapshot']['instagramURL']!=""){
                                            $('#instagramLink').attr('href', data['snapshot']['instagramURL'])
                                            $('#editInstagram').val(data['snapshot']['instagramURL'])
                                            $('#instagramField').show()
                                        }
                                        else{
                                            $('#instagramField').hide()
                                        }
                                        
                                        if(data['snapshot']['facebookURL']!=""){
                                            $('#facebookLink').attr('href', data['snapshot']['facebookURL'])
                                            $('#editFacebook').val(data['snapshot']['facebookURL'])
                                            $('#facebookField').show()
                                        }
                                        else{
                                            $('#facebookField').hide()
                                        }
                                        
                                    }
                                }
                                catch(err){}
                            },
                            error: function(XMLHttpRequest, textStatus, errorThrown) { 
                                
                            } 
                        });
                    }  
                }
                
                function resizeProfilerForIcon(dataURL){
                    // resize profileImage
                    var img = document.createElement("img");
                    img.src = dataURL

                    var canvas = document.createElement("canvas");
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);

                    var MAX_WIDTH = 64;
                    var MAX_HEIGHT = 64;
                    var width = img.width;
                    var height = img.height;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    var ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0, width, height);
                    dataurl = canvas.toDataURL('image/jpeg', 0.7);
                    localStorage.setItem('profileIcon', dataurl)
                }
                
                function initApp() {    
                    firebase.auth().onAuthStateChanged(function(user) {
                        
                        
                        if (user) {
                            // User is signed in.
                            var email = user.email;
                            var uid = user.uid;
                            localStorage.setItem('userId', uid);
                            
                            var shareableLink = (window.location.origin+'/profile.html?p='+uid).replace('http://', '').replace('https://', '')
                            $('#toshare').html(shareableLink)
                            $('#logoutButton').removeClass('hidden')
                            $('#editButton').removeClass('hidden')
                            $('#pushButton').removeClass('hidden')
                            $('#logoutButton').show()
                            $('#editButton').show()
                            $('#pushButton').show()
                            $('#toshare').show()
                            $('#toShareLine').show()
                            $('#toshareIcon').show()
                            $('#settingsButtons').attr('style', 'display: flex')
                            $('#signInLink').hide()

                            getPublicInfo(uid)
                            
                        }
                        else {
                            const params = new URLSearchParams(window.location.search);  
                            uid = params.get("p");
                            getPublicInfo(uid)
                            $('#subButton').show()
                            $('#signInLink').show()
                        }
                    }, function(error) {
                      console.log(error);
                    });
                }
                
                function edit(){
                    $('#profileName').hide()
                    $('#tagline').hide()
                    $('#twitterField').hide()
                    $('#instagramField').hide()
                    $('#facebookField').hide()
                    
                    $('#editName').show()
                    $('#editTagline').show()
                    $('#imageChooser').addClass('chooser-show')
                    $('#editTwitterField').show()
                    $('#editInstagramField').show()
                    $('#editFacebookField').show()
                    $('#editButton').hide()
                    $('#pushButton').hide()
                    $('#logoutButton').hide()
                    $('#saveButton').show()
                    
                    var fileReader = new FileReader();
                    fileReader.addEventListener("load", function(e) {
                        $('#profileImage').attr('src', e.target.result.replace('data:image/png;base64', 'data:image/jpeg;base64')) 
                        
                        
                        resizeProfilerForIcon(e.target.result)
                    }); 

                    $('#imageFileInput').change(function(e) { 
                        fileReader.readAsDataURL( this.files[0] );
                    });
                }
                
                function save(){
                    var updateURL = "https://autoempushy.herokuapp.com/v1/update-profile";
                    name = $('#editName').val()
                    tagline = $('#editTagline').val()
                    twitterURL = $('#editTwitter').val()
                    instagramURL = $('#editInstagram').val()
                    facebookURL = $('#editFacebook').val()
                    profileImage = $('#profileImage').attr('src').replace('data:image/png;base64', '').replace('data:image/jpeg;base64', '')
                    
                    $('#profileName').text(name)
                    $('#tagline').text(tagline)
                    $('#twitterLink').attr('href', twitterURL)
                    $('#instagramLink').attr('href', instagramURL)
                    $('#facebookLink').attr('href', facebookURL)
                    
                    $('#profileName').show()
                    $('#tagline').show()
                    
                    if(twitterURL==""){
                        $('#twitterField').hide()
                    }
                    else{
                        $('#twitterField').removeClass('hidden')
                        $('#twitterField').show()
                    }

                    if(instagramURL==""){
                        $('#instagramField').hide()
                    }
                    else{
                        $('#instagramField').removeClass('hidden')
                        $('#instagramField').show()
                    }

                    if(facebookURL==""){
                        $('#facebookField').hide()
                    }
                    else{
                        $('#facebookField').removeClass('hidden')
                        $('#facebookField').show()
                    }
                    
                    $('#editName').hide()
                    $('#editTagline').hide()
                    $('#imageChooser').removeClass('chooser-show')
                    $('#editTwitterField').hide()
                    $('#editInstagramField').hide()
                    $('#editFacebookField').hide()
                    $('#saveButton').hide()
                    $('#logoutButton').show()
                    $('#editButton').show()
                    $('#pushButton').show()
                    
                    uid = localStorage.getItem('userId')
                    if(uid!=null){
                        var formData = JSON.stringify({
                            'uid': uid,
                            'name': name,
                            'tagline': tagline,
                            'twitterURL': twitterURL,
                            'instagramURL': instagramURL,
                            'facebookURL': facebookURL,
                            'profileImage': profileImage
                        })

                        $.ajax ({
                            url: updateURL,
                            type: "POST",
                            data: formData,
                            dataType: "json",
                            contentType: "application/json; charset=utf-8",
                            crossDomain: true,
                            success: function(data) {
                                try{

                                }
                                catch(err){}
                            },
                            error: function(XMLHttpRequest, textStatus, errorThrown) { 

                            } 
                        });
                    } 
                    
                    
                }
                
                function logout(){
                    localStorage.clear();
                    firebase.auth().signOut();
                    window.location.replace("/index.html");
                }
                
                function copyShareLink() {
                    var copyText = 'http://'+$('#toshare').text();
                    var textarea = document.createElement("textarea");
                    textarea.textContent = copyText;
                    textarea.style.position = "fixed"; // Prevent scrolling to bottom of page in MS Edge.
                    textarea.style.textTransform = "none";
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand("copy"); 
                    document.body.removeChild(textarea);                    
                    Message.default.info('Pushd link copied')
                }
                
                function settings() {
                    Message.default.info('Feature coming soon')
                }
                
                function insights() {
                    Message.default.info('Feature coming soon')                 
                }
                
                function control() {
                    Message.default.info('Feature coming soon')                   
                }
                
                function pushButtonClick(){
                    imageURL = $('#profileImage').attr('src')
                    resizeProfilerForIcon(imageURL)
                    window.location.replace('/push.html')
                }
                
                
			</script>

	</body>
</html>